<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FYFC 2025 - Quarter Finals Draw Control</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#03bded">
    <link rel="icon" type="image/svg+xml" href="Tounament logo.svg">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Bebas+Neue&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #03bded;
            --secondary-color: #029ac0;
            --accent-color: #ff6b35;
            --text-color: #fff;
            --bg-color: #0a0b0c;
            --card-bg: #1a1d21;
            --border-color: #2a2f35;
            --success-color: #44ff44;
            --warning-color: #ffaa00;
            --error-color: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: 
                radial-gradient(ellipse at top, rgba(3, 189, 237, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(255, 107, 53, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, #0a0b0c 0%, #1a1d21 50%, #2a2f35 100%);
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .tournament-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 4rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(3, 189, 237, 0.5);
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        .control-subtitle {
            font-size: 1.5rem;
            opacity: 0.9;
            font-weight: 300;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }

        .back-btn {
            position: absolute;
            top: -10px;
            left: 0;
            background: rgba(26, 29, 33, 0.9);
            color: var(--text-color);
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            color: white;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .nav-button {
            background: rgba(26, 29, 33, 0.8);
            color: var(--text-color);
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-button:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            color: white;
        }

        .instructions {
            background: rgba(26, 29, 33, 0.8);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .instructions h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .instructions p {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .group-section {
            background: rgba(26, 29, 33, 0.8);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .group-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(3, 189, 237, 0.3);
            padding-bottom: 10px;
        }

        .teams-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .team-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .team-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0.7;
        }

        .team-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 32px rgba(3, 189, 237, 0.3);
            border-color: rgba(3, 189, 237, 0.4);
            background: rgba(3, 189, 237, 0.1);
        }

        .team-card.assigned {
            border-color: var(--success-color);
            background: rgba(68, 255, 68, 0.1);
        }

        .team-card.assigned::before {
            background: var(--success-color);
        }

        .team-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .team-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 15px rgba(3, 189, 237, 0.4);
            flex-shrink: 0;
        }

        .team-logo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .team-info {
            flex: 1;
        }

        .team-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .team-position {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .team-assignment {
            font-size: 0.8rem;
            color: var(--success-color);
            font-weight: 600;
            background: rgba(68, 255, 68, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .team-status {
            font-size: 0.8rem;
            color: var(--error-color);
            font-weight: 600;
            background: rgba(255, 68, 68, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 5px;
        }

        .team-stats {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 3px;
            line-height: 1.3;
        }

        .team-card.assigned .team-stats {
            color: rgba(255, 255, 255, 0.8);
        }

        .team-card.disabled {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.02) !important;
            border-color: rgba(255, 255, 255, 0.05) !important;
            cursor: not-allowed !important;
        }

        .team-card.disabled:hover {
            transform: none !important;
            box-shadow: none !important;
            border-color: rgba(255, 255, 255, 0.05) !important;
            background: rgba(255, 255, 255, 0.02) !important;
        }

        .team-card.disabled .team-name {
            color: rgba(255, 255, 255, 0.4);
        }

        .team-card.disabled .team-position {
            color: rgba(255, 255, 255, 0.3);
        }

        .team-card.disabled .team-stats {
            color: rgba(255, 255, 255, 0.3);
        }

        .team-position {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .position-rank {
            font-size: 1.2em;
        }

        .quarter-finals-grid {
            background: rgba(26, 29, 33, 0.8);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .qf-grid-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 2rem;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            letter-spacing: 2px;
        }

        .qf-matches {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .qf-match {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .qf-match:hover {
            border-color: rgba(3, 189, 237, 0.3);
            background: rgba(3, 189, 237, 0.05);
        }

        .qf-match-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.3rem;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 15px;
        }

        .qf-slots {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .qf-slot {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qf-slot:hover {
            border-color: var(--primary-color);
            background: rgba(3, 189, 237, 0.1);
        }

        .qf-slot.filled {
            border-style: solid;
            border-color: var(--success-color);
            background: rgba(68, 255, 68, 0.1);
            cursor: default;
        }

        .qf-slot.filled:hover {
            border-color: var(--accent-color);
            background: rgba(255, 107, 53, 0.1);
        }

        .qf-slot-content {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .qf-slot-logo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            flex-shrink: 0;
        }

        .qf-slot-info {
            flex: 1;
            text-align: left;
        }

        .qf-slot-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .qf-slot-position {
            font-size: 0.7rem;
            color: var(--primary-color);
            text-transform: uppercase;
        }

        .qf-slot-empty {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            font-size: 0.9rem;
        }

        .vs-separator {
            text-align: center;
            color: var(--accent-color);
            font-family: 'Bebas Neue', cursive;
            font-size: 1.1rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .action-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(3, 189, 237, 0.3);
        }

        .action-button:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(3, 189, 237, 0.4);
        }

        .action-button.clear {
            background: var(--error-color);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
        }

        .action-button.clear:hover {
            background: #cc0000;
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.4);
        }

        .action-button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Slot selection modal */
        .slot-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            z-index: 3000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-content {
            background: rgba(26, 29, 33, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.8rem;
            color: var(--primary-color);
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .slot-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .slot-option:hover {
            background: rgba(3, 189, 237, 0.1);
            border-color: rgba(3, 189, 237, 0.3);
            transform: translateY(-2px);
        }

        .slot-option.occupied {
            background: rgba(255, 68, 68, 0.1);
            border-color: rgba(255, 68, 68, 0.3);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .slot-option.occupied:hover {
            transform: none;
        }

        .slot-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .slot-status {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .slot-occupied-team {
            font-size: 0.8rem;
            color: var(--error-color);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .tournament-title {
                font-size: 2.5rem;
            }
            
            .teams-grid {
                grid-template-columns: 1fr;
            }
            
            .qf-matches {
                grid-template-columns: 1fr;
            }

            .slots-grid {
                grid-template-columns: 1fr;
            }

            .draw-selection {
                font-size: 8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="match-management.html" class="back-btn">← Back to Home</a>
        
        <div class="header">
            <h1 class="tournament-title">FYFC 2025</h1>
            <p class="control-subtitle">Quarter Finals Draw Control</p>
        </div>

        <div class="navigation">
            <a href="qf-draw-display.html" class="nav-button">View Draw Display</a>
        </div>

        <div class="instructions">
            <h3>How to Set Quarter Finals Draw</h3>
            <p>Click on qualified teams (1st and 2nd place from each group) to select which quarter final slot they should be assigned to. Only qualified teams can participate in the quarter finals.</p>
        </div>

        <div class="groups-container" id="groups-container">
            <!-- Groups will be populated here -->
        </div>

        <div class="quarter-finals-grid">
            <h2 class="qf-grid-title">Quarter Finals Bracket</h2>
            <div class="qf-matches" id="qf-matches">
                <!-- Quarter final matches will be shown here -->
            </div>
        </div>

        <div class="actions">
            <button class="action-button clear" onclick="clearDraw()">Clear All</button>
        </div>
    </div>

    <!-- Slot selection modal -->
    <div class="slot-modal" id="slot-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Select Quarter Final Slot</h3>
                <button class="close-modal" onclick="closeSlotModal()">&times;</button>
            </div>
            <div class="slots-grid" id="slots-grid">
                <!-- Slot options will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCapatOZLxm387yKpFUPD-K8Dv24UBcP9k",
            authDomain: "exvertixe-futsal.firebaseapp.com",
            databaseURL: "https://exvertixe-futsal-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "exvertixe-futsal",
            storageBucket: "exvertixe-futsal.firebasestorage.app",
            messagingSenderId: "992942970225",
            appId: "1:992942970225:web:25bd160a3ac2139b5612d0",
            measurementId: "G-130DYDBMF6"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global data storage
        let teams = {};
        let drawAssignments = {};
        let quarterFinalDraw = {};
        let matchEvents = {};
        let matchScores = {};
        let matchState = {};
        let teamStandings = {};
        let currentSelectedTeam = null;

        // Quarter final slots structure
        const qfSlots = [
            { id: 'QF1_team1', match: 'QF1', position: 'team1', label: 'Quarter Final 1 - Team 1' },
            { id: 'QF1_team2', match: 'QF1', position: 'team2', label: 'Quarter Final 1 - Team 2' },
            { id: 'QF2_team1', match: 'QF2', position: 'team1', label: 'Quarter Final 2 - Team 1' },
            { id: 'QF2_team2', match: 'QF2', position: 'team2', label: 'Quarter Final 2 - Team 2' },
            { id: 'QF3_team1', match: 'QF3', position: 'team1', label: 'Quarter Final 3 - Team 1' },
            { id: 'QF3_team2', match: 'QF3', position: 'team2', label: 'Quarter Final 3 - Team 2' },
            { id: 'QF4_team1', match: 'QF4', position: 'team1', label: 'Quarter Final 4 - Team 1' },
            { id: 'QF4_team2', match: 'QF4', position: 'team2', label: 'Quarter Final 4 - Team 2' }
        ];

        // Team name to logo filename mapping
        function getTeamLogoFilename(teamName) {
            const logoMap = {
                'Amigos': 'amigos',
                'Best': 'best',
                'Brave Generation Sports Club': 'brave_generation_sports_club',
                'Foemathi': 'foemathi',
                'Foemathi Jr': 'foemathi_jr',
                'Goalhians': 'goalhians',
                'Goalhi Sports Club': 'goalhi_sports_club',
                'G Star Sports Club': 'g_star_sports_club',
                'Kanmathi FC': 'kanmathi_fc',
                'Kanmathi SC': 'kanmathi_sc',
                'Laamu Blues': 'laamu_blues',
                'LeCrose Sports Club': 'lecrose_sports_club',
                'Maahinna United': 'maahinna_united',
                'Outreef Sports Club': 'outreef_sports_club',
                'Youth Academy': 'youth_academy'
            };
            
            return logoMap[teamName] || teamName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').toLowerCase();
        }

        // Get team data from position
        function getTeamData(position) {
            if (!drawAssignments[position] || !teams[drawAssignments[position]]) {
                return null;
            }
            
            const teamId = drawAssignments[position];
            const team = teams[teamId];
            
            return {
                id: teamId,
                name: team.teamName,
                logo: getTeamLogoFilename(team.teamName),
                position: position
            };
        }

        // Match schedule and calculation functions (from team-standings.html)
        const matchSchedule = {
            'October 26': [
                { teams: ['A1', 'A2'], type: 'Group A', time: '4:00 PM' },
                { teams: ['A3', 'A4'], type: 'Group A', time: '5:00 PM' },
                { teams: ['B1', 'B2'], type: 'Group B', time: '8:00 PM' },
                { teams: ['C1', 'C2'], type: 'Group C', time: '9:00 PM' },
                { teams: ['D1', 'D2'], type: 'Group D', time: '10:00 PM' }
            ],
            'October 27': [
                { teams: ['A1', 'A3'], type: 'Group A', time: '8:15 PM' },
                { teams: ['A2', 'A4'], type: 'Group A', time: '9:15 PM' },
                { teams: ['B1', 'B3'], type: 'Group B', time: '10:15 PM' }
            ],
            'October 28': [
                { teams: ['C1', 'C3'], type: 'Group C', time: '8:15 PM' },
                { teams: ['D1', 'D3'], type: 'Group D', time: '9:15 PM' },
                { teams: ['B2', 'B3'], type: 'Group B', time: '10:15 PM' }
            ],
            'October 29': [
                { teams: ['A1', 'A4'], type: 'Group A', time: '8:15 PM' },
                { teams: ['A2', 'A3'], type: 'Group A', time: '9:15 PM' },
                { teams: ['C2', 'C3'], type: 'Group C', time: '10:15 PM' }
            ],
            'October 30': [
                { teams: ['D2', 'D3'], type: 'Group D', time: '9:15 PM' }
            ]
        };

        function generateMatchId(date, match) {
            const dateParts = date.toLowerCase().split(' ');
            const month = dateParts[0];
            const day = dateParts[1];
            const dateStr = `${month}${day}`;
            
            const team1 = match.teams[0];
            const team2 = match.teams[1];
            const timeFormatted = match.time.replace(/[^0-9]/g, '');
            
            return `${dateStr}-${team1}vs${team2}-${timeFormatted}`;
        }

        function getGroupStageMatches() {
            const matches = [];
            
            for (const date of Object.keys(matchSchedule)) {
                for (const match of matchSchedule[date]) {
                    const matchId = generateMatchId(date, match);
                    matches.push({
                        id: matchId,
                        teams: match.teams,
                        type: match.type,
                        time: match.time,
                        date: date,
                        fromDatabase: false
                    });
                }
            }

            const allMatchIds = [
                ...Object.keys(matchEvents || {}),
                ...Object.keys(matchScores || {}),
                ...Object.keys(matchState || {})
            ];
            
            const uniqueDbMatches = [...new Set(allMatchIds)];
            
            uniqueDbMatches.forEach(matchId => {
                const parts = matchId.split('-');
                if (parts.length === 3) {
                    const teamsStr = parts[1];
                    const vsIndex = teamsStr.indexOf('vs');
                    if (vsIndex > 0) {
                        const team1 = teamsStr.substring(0, vsIndex);
                        const team2 = teamsStr.substring(vsIndex + 2);
                        
                        if (!matches.find(m => m.id === matchId)) {
                            const groupLetter1 = team1.charAt(0);
                            const groupLetter2 = team2.charAt(0);
                            
                            if (groupLetter1 === groupLetter2) {
                                matches.push({
                                    id: matchId,
                                    teams: [team1, team2],
                                    type: `Group ${groupLetter1}`,
                                    time: 'Unknown',
                                    date: 'Unknown',
                                    fromDatabase: true
                                });
                            }
                        }
                    }
                }
            });
            
            console.log(`Total matches found: ${matches.length} (schedule: ${matches.filter(m => !m.fromDatabase).length}, database: ${matches.filter(m => m.fromDatabase).length})`);
            return matches;
        }

        function initializeStandings() {
            teamStandings = {};
            const allPositions = ['A1', 'A2', 'A3', 'A4', 'B1', 'B2', 'B3', 'C1', 'C2', 'C3', 'D1', 'D2', 'D3'];
            
            allPositions.forEach(position => {
                teamStandings[position] = {
                    position: position,
                    group: position.charAt(0),
                    matchesPlayed: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    points: 0,
                    goalsScored: 0,
                    goalsConceded: 0,
                    goalDifference: 0
                };
            });
        }

        function getMatchScore(matchId) {
            // First, check if we have saved match scores (preferred method)
            if (matchScores[matchId] && matchScores[matchId].current) {
                const score = matchScores[matchId].current;
                console.log(`Using saved scores for ${matchId}: ${score.team1}-${score.team2}`);
                return score;
            }
            
            // Fallback to calculating from events
            const matchEventsData = matchEvents[matchId] || {};
            let team1Goals = 0;
            let team2Goals = 0;
            
            Object.values(matchEventsData).forEach(event => {
                if (event.eventType === 'goal') {
                    if (event.teamKey === 'team1') {
                        team1Goals++;
                    } else if (event.teamKey === 'team2') {
                        team2Goals++;
                    }
                } else if (event.eventType === 'own-goal') {
                    // Own goal counts for the opponent
                    if (event.teamKey === 'team1') {
                        team2Goals++;
                    } else if (event.teamKey === 'team2') {
                        team1Goals++;
                    }
                }
            });
            
            const calculatedScore = { team1: team1Goals, team2: team2Goals };
            console.log(`Calculated scores from events for ${matchId}: ${calculatedScore.team1}-${calculatedScore.team2}`);
            return calculatedScore;
        }

        function isMatchPlayed(matchId) {
            // Check match state first - only count matches with "finished" status
            if (matchState[matchId] && matchState[matchId].state) {
                const state = matchState[matchId].state;
                const isFinished = state === 'finished';
                console.log(`Match ${matchId} state: ${state} (${isFinished ? 'FINISHED' : 'NOT FINISHED'})`);
                return isFinished;
            }
            
            // Fallback: Check if we have match scores
            if (matchScores[matchId] && matchScores[matchId].current) {
                const scores = matchScores[matchId].current;
                const hasScore = scores.team1 > 0 || scores.team2 > 0;
                console.log(`Match ${matchId} scores: ${scores.team1}-${scores.team2} (${hasScore ? 'HAS SCORE' : 'NO SCORE'})`);
                return hasScore;
            }
            
            // Fallback: Check if we have match events with goals
            const matchEventsData = matchEvents[matchId] || {};
            const eventKeys = Object.keys(matchEventsData);
            const hasGoals = eventKeys.some(key => 
                matchEventsData[key].eventType === 'goal' || 
                matchEventsData[key].eventType === 'own-goal'
            );
            
            console.log(`Match ${matchId} events: ${eventKeys.length} events (${hasGoals ? 'HAS GOALS' : 'NO GOALS'})`);
            return hasGoals;
        }

        function calculateStandings() {
            try {
                console.log('=== CALCULATING STANDINGS ===');
                initializeStandings();
                
                const groupStageMatches = getGroupStageMatches();
                console.log('Processing matches for standings:', groupStageMatches.length, 'matches');
                
                let playedMatches = 0;
                let skippedMatches = 0;
                
                groupStageMatches.forEach((match) => {
                    const matchId = match.id;
                    
                    if (!isMatchPlayed(matchId)) {
                        skippedMatches++;
                        return;
                    }
                    
                    playedMatches++;
                    console.log(`Processing played match ${playedMatches}: ${matchId}`);
                    
                    const score = getMatchScore(matchId);
                    const team1Goals = score.team1;
                    const team2Goals = score.team2;
                    
                    const team1Position = match.teams[0];
                    const team2Position = match.teams[1];
                    
                    console.log(`Match result: ${team1Position} ${team1Goals} - ${team2Goals} ${team2Position}`);
                    
                    if (!teamStandings[team1Position] || !teamStandings[team2Position]) {
                        console.error(`Invalid team positions: ${team1Position}, ${team2Position}`);
                        return;
                    }
                    
                    // Update match statistics
                    teamStandings[team1Position].matchesPlayed++;
                    teamStandings[team2Position].matchesPlayed++;
                    
                    teamStandings[team1Position].goalsScored += team1Goals;
                    teamStandings[team1Position].goalsConceded += team2Goals;
                    
                    teamStandings[team2Position].goalsScored += team2Goals;
                    teamStandings[team2Position].goalsConceded += team1Goals;
                    
                    // Determine match result
                    if (team1Goals > team2Goals) {
                        // Team 1 wins
                        teamStandings[team1Position].wins++;
                        teamStandings[team1Position].points += 3;
                        teamStandings[team2Position].losses++;
                    } else if (team2Goals > team1Goals) {
                        // Team 2 wins
                        teamStandings[team2Position].wins++;
                        teamStandings[team2Position].points += 3;
                        teamStandings[team1Position].losses++;
                    } else {
                        // Draw
                        teamStandings[team1Position].draws++;
                        teamStandings[team1Position].points += 1;
                        teamStandings[team2Position].draws++;
                        teamStandings[team2Position].points += 1;
                    }
                    
                    // Calculate goal difference
                    teamStandings[team1Position].goalDifference = 
                        teamStandings[team1Position].goalsScored - teamStandings[team1Position].goalsConceded;
                    teamStandings[team2Position].goalDifference = 
                        teamStandings[team2Position].goalsScored - teamStandings[team2Position].goalsConceded;
                });
                
                console.log(`Match processing complete: ${playedMatches} played, ${skippedMatches} skipped`);
                console.log('Final standings calculated. Sample:', {
                    A1: teamStandings['A1'],
                    B1: teamStandings['B1'],
                    C1: teamStandings['C1'],
                    D1: teamStandings['D1']
                });
            } catch (error) {
                console.error('Error calculating standings:', error);
                console.error('Error stack:', error.stack);
            }
        }

        // Team selection
        function selectTeam(position) {
            const teamData = getTeamData(position);
            if (!teamData) return;

            currentSelectedTeam = { position, teamData };
            
            // Show slot selection modal immediately
            showSlotModal(teamData);
        }

        function showSlotModal(teamData) {
            const modal = document.getElementById('slot-modal');
            const modalTitle = document.getElementById('modal-title');
            const slotsGrid = document.getElementById('slots-grid');
            
            modalTitle.textContent = `Select slot for ${teamData.name}`;
            
            // Clear and populate slots
            slotsGrid.innerHTML = '';
            
            qfSlots.forEach(slot => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'slot-option';
                
                // Check if slot is occupied
                const isOccupied = quarterFinalDraw[slot.match] && quarterFinalDraw[slot.match][slot.position];
                if (isOccupied) {
                    slotDiv.classList.add('occupied');
                }
                
                slotDiv.innerHTML = `
                    <div class="slot-label">${slot.label}</div>
                    <div class="${isOccupied ? 'slot-occupied-team' : 'slot-status'}">
                        ${isOccupied ? 'Occupied by ' + getTeamNameFromPosition(quarterFinalDraw[slot.match][slot.position]) : 'Available'}
                    </div>
                `;
                
                if (!isOccupied) {
                    slotDiv.onclick = () => assignTeamToSlot(slot);
                }
                
                slotsGrid.appendChild(slotDiv);
            });
            
            // Show modal
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.style.opacity = '1';
        }

        function getTeamNameFromPosition(position) {
            const teamData = getTeamData(position);
            return teamData ? teamData.name : position;
        }

        function assignTeamToSlot(slot) {
            if (!currentSelectedTeam) return;
            
            // Remove team from any existing slot
            Object.keys(quarterFinalDraw).forEach(matchKey => {
                Object.keys(quarterFinalDraw[matchKey]).forEach(posKey => {
                    if (quarterFinalDraw[matchKey][posKey] === currentSelectedTeam.position) {
                        delete quarterFinalDraw[matchKey][posKey];
                    }
                });
            });
            
            // Assign team to new slot
            if (!quarterFinalDraw[slot.match]) {
                quarterFinalDraw[slot.match] = {};
            }
            quarterFinalDraw[slot.match][slot.position] = currentSelectedTeam.position;
            
            console.log('Team assigned:', currentSelectedTeam.teamData.name, 'to', slot.label);
            
            // 🔥 IMMEDIATELY SAVE TO FIREBASE LIKE MAIN DRAW
            database.ref('quarterFinalDraw').set(quarterFinalDraw)
                .then(() => {
                    console.log('✅ Quarter final assignment saved to Firebase immediately');
                })
                .catch(error => {
                    console.error('❌ Error saving to Firebase:', error);
                });
            
            // Update displays
            updateTeamsDisplay();
            updateQuarterFinalsDisplay();
            
            // Close modal
            closeSlotModal();
        }

        function closeSlotModal() {
            const modal = document.getElementById('slot-modal');
            modal.style.opacity = '0';
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            
            // Reset selection
            currentSelectedTeam = null;
        }

        // Display functions
        function updateTeamsDisplay() {
            const groupsContainer = document.getElementById('groups-container');
            groupsContainer.innerHTML = '';
            
            // Calculate current standings
            console.log('=== UPDATE TEAMS DISPLAY ===');
            console.log('Data available:', {
                teams: Object.keys(teams).length,
                drawAssignments: Object.keys(drawAssignments).length,
                matchEvents: Object.keys(matchEvents).length,
                matchScores: Object.keys(matchScores).length,
                matchState: Object.keys(matchState).length
            });
            
            calculateStandings();
            
            // Debug: Show sample standings after calculation
            console.log('Sample standings after calculation:', {
                A1: teamStandings['A1'],
                A2: teamStandings['A2'],
                A3: teamStandings['A3']
            });
            
            // Get assigned teams
            const assignedTeams = new Set();
            Object.values(quarterFinalDraw).forEach(match => {
                Object.values(match).forEach(position => {
                    assignedTeams.add(position);
                });
            });
            
            // Create teams array with standings data
            const teamsWithStandings = [];
            Object.entries(drawAssignments).forEach(([position, teamId]) => {
                const team = teams[teamId];
                const standings = teamStandings[position];
                if (team && standings) {
                    teamsWithStandings.push({
                        position,
                        teamId,
                        team,
                        standings,
                        isAssigned: assignedTeams.has(position)
                    });
                }
            });
            
            // Group teams by their group and sort within each group
            const groups = ['A', 'B', 'C', 'D'];
            
            groups.forEach(groupLetter => {
                // Get teams for this group
                const groupTeams = teamsWithStandings.filter(t => t.standings.group === groupLetter);
                
                if (groupTeams.length === 0) return;
                
                // Sort teams within group by performance
                groupTeams.sort((a, b) => {
                    if (b.standings.points !== a.standings.points) {
                        return b.standings.points - a.standings.points; // Higher points first
                    }
                    if (b.standings.goalDifference !== a.standings.goalDifference) {
                        return b.standings.goalDifference - a.standings.goalDifference; // Better GD first
                    }
                    if (b.standings.goalsScored !== a.standings.goalsScored) {
                        return b.standings.goalsScored - a.standings.goalsScored; // More goals first
                    }
                    return a.position.localeCompare(b.position); // Fallback to position name
                });
                
                // Create group section
                const groupSection = document.createElement('div');
                groupSection.className = 'group-section';
                
                // Group title
                const groupTitle = document.createElement('h3');
                groupTitle.className = 'group-title';
                groupTitle.textContent = `Group ${groupLetter}`;
                groupSection.appendChild(groupTitle);
                
                // Teams grid for this group
                const teamsGrid = document.createElement('div');
                teamsGrid.className = 'teams-grid';
                
                // Add teams to this group
                groupTeams.forEach((teamInfo, index) => {
                    const { position, team, standings, isAssigned } = teamInfo;
                    
                    // Determine team's group position (1st, 2nd, etc.)
                    const groupPosition = index + 1;
                    const isQualified = groupPosition <= 2; // Only 1st and 2nd place qualify for QF
                    
                    const teamCard = document.createElement('div');
                    let cardClasses = 'team-card';
                    if (isAssigned) cardClasses += ' assigned';
                    if (!isQualified) cardClasses += ' disabled';
                    teamCard.className = cardClasses;
                    
                    // Only add click handler for qualified teams
                    if (isQualified) {
                        teamCard.onclick = () => selectTeam(position);
                        teamCard.style.cursor = 'pointer';
                    } else {
                        teamCard.style.cursor = 'not-allowed';
                        teamCard.onclick = null;
                    }
                    
                    const logoFileName = getTeamLogoFilename(team.teamName);
                    
                    let positionText = '';
                    if (groupPosition === 1) positionText = '🥇 1st Place';
                    else if (groupPosition === 2) positionText = '🥈 2nd Place';
                    else if (groupPosition === 3) positionText = '🥉 3rd Place';
                    else positionText = `${groupPosition}th Place`;
                    
                    teamCard.innerHTML = `
                        <div class="team-content">
                            <img class="team-logo" src="logos/${logoFileName}.jpg" 
                                 alt="${team.teamName}" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="team-logo-placeholder" style="display: none;">${position}</div>
                            <div class="team-info">
                                <div class="team-name">${team.teamName}</div>
                                <div class="team-position">${positionText}</div>
                                <div class="team-stats">
                                    ${standings.points} pts • ${standings.matchesPlayed} played • ${standings.wins}W ${standings.draws}D ${standings.losses}L • GD: ${standings.goalDifference > 0 ? '+' : ''}${standings.goalDifference}
                                </div>
                                ${isAssigned ? '<div class="team-assignment">Assigned to QF</div>' : ''}
                                ${!isQualified ? '<div class="team-status">Not Qualified for Quarter Finals</div>' : ''}
                            </div>
                        </div>
                    `;
                    
                    teamsGrid.appendChild(teamCard);
                });
                
                groupSection.appendChild(teamsGrid);
                groupsContainer.appendChild(groupSection);
            });
        }

        function updateQuarterFinalsDisplay() {
            const qfMatches = document.getElementById('qf-matches');
            qfMatches.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const matchData = quarterFinalDraw[`QF${i}`] || {};
                
                const matchDiv = document.createElement('div');
                matchDiv.className = 'qf-match';
                
                matchDiv.innerHTML = `
                    <div class="qf-match-title">QUARTER FINAL ${i}</div>
                    <div class="qf-slots">
                        ${createSlotHTML(`QF${i}`, 'team1', matchData.team1)}
                        <div class="vs-separator">VS</div>
                        ${createSlotHTML(`QF${i}`, 'team2', matchData.team2)}
                    </div>
                `;
                
                qfMatches.appendChild(matchDiv);
            }
        }

        function createSlotHTML(match, position, assignedPosition) {
            if (assignedPosition) {
                const teamData = getTeamData(assignedPosition);
                if (teamData) {
                    return `
                        <div class="qf-slot filled" onclick="removeTeamFromSlot('${match}', '${position}')">
                            <div class="qf-slot-content">
                                <img class="qf-slot-logo" src="logos/${teamData.logo}.jpg" 
                                     alt="${teamData.name}" 
                                     onerror="this.style.display='none';">
                                <div class="qf-slot-info">
                                    <div class="qf-slot-name">${teamData.name}</div>
                                    <div class="qf-slot-position">${assignedPosition}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            return `
                <div class="qf-slot">
                    <div class="qf-slot-empty">Click team to assign</div>
                </div>
            `;
        }

        function removeTeamFromSlot(match, position) {
            if (quarterFinalDraw[match] && quarterFinalDraw[match][position]) {
                delete quarterFinalDraw[match][position];
                
                // Clean up empty matches
                if (Object.keys(quarterFinalDraw[match]).length === 0) {
                    delete quarterFinalDraw[match];
                }
                
                // 🔥 IMMEDIATELY SAVE TO FIREBASE LIKE MAIN DRAW
                database.ref('quarterFinalDraw').set(quarterFinalDraw)
                    .then(() => {
                        console.log('✅ Quarter final removal saved to Firebase immediately');
                    })
                    .catch(error => {
                        console.error('❌ Error saving removal to Firebase:', error);
                    });
                
                updateTeamsDisplay();
                updateQuarterFinalsDisplay();
            }
        }



        // Clear function

        function clearDraw() {
            if (confirm('Are you sure you want to clear all quarter final assignments?')) {
                quarterFinalDraw = {};
                updateTeamsDisplay();
                updateQuarterFinalsDisplay();
                
                // Also clear from Firebase
                database.ref('quarterFinalDraw').remove()
                    .then(() => {
                        console.log('Quarter finals draw cleared from Firebase');
                    })
                    .catch(error => {
                        console.error('Error clearing draw from Firebase:', error);
                    });
            }
        }

        // Firebase listeners
        function setupFirebaseListeners() {
            let dataLoaded = {
                teams: false,
                drawAssignments: false,
                matchEvents: false,
                matchScores: false,
                matchState: false,
                quarterFinalDraw: false
            };

            function checkAndUpdate(source) {
                dataLoaded[source] = true;
                console.log('Data loaded status:', dataLoaded);
                
                // Only update when we have the essential data for standings calculation
                const hasEssentialData = dataLoaded.teams && 
                                        dataLoaded.drawAssignments && 
                                        dataLoaded.matchEvents && 
                                        dataLoaded.matchScores && 
                                        dataLoaded.matchState;
                
                if (hasEssentialData) {
                    console.log('All essential data loaded, updating displays');
                    updateTeamsDisplay();
                    updateQuarterFinalsDisplay();
                }
            }

            // Listen for team data
            database.ref('applications').on('value', (snapshot) => {
                teams = snapshot.val() || {};
                console.log('Teams updated:', Object.keys(teams).length);
                checkAndUpdate('teams');
            });

            // Listen for draw assignments
            database.ref('drawAssignments').on('value', (snapshot) => {
                drawAssignments = snapshot.val() || {};
                console.log('Draw assignments updated:', Object.keys(drawAssignments).length);
                checkAndUpdate('drawAssignments');
            });

            // Listen for match events (for standings calculation)
            database.ref('matchEvents').on('value', (snapshot) => {
                matchEvents = snapshot.val() || {};
                console.log('Match events updated:', Object.keys(matchEvents).length);
                checkAndUpdate('matchEvents');
            });

            // Listen for match scores (for standings calculation)
            database.ref('matchScores').on('value', (snapshot) => {
                matchScores = snapshot.val() || {};
                console.log('Match scores updated:', Object.keys(matchScores).length);
                checkAndUpdate('matchScores');
            });

            // Listen for match states (for standings calculation)
            database.ref('matchState').on('value', (snapshot) => {
                matchState = snapshot.val() || {};
                console.log('Match states updated:', Object.keys(matchState).length);
                checkAndUpdate('matchState');
            });

            // Listen for quarter final draw
            database.ref('quarterFinalDraw').on('value', (snapshot) => {
                quarterFinalDraw = snapshot.val() || {};
                console.log('Quarter final draw updated:', quarterFinalDraw);
                checkAndUpdate('quarterFinalDraw');
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupFirebaseListeners();
            updateQuarterFinalsDisplay();
        });
    </script>
</body>
</html>